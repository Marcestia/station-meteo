{% extends "base.html" %}

{% block title %}MÃ©tÃ©o - {{ selected_location|capitalize }}{% endblock %}

{% block content %}

<!-- ParamÃ¨tres -->
<section class="card settings">
  <h2>ğŸ”§ ParamÃ¨tres</h2>
  <form class="settings-form" onsubmit="return false;">
    <!-- SÃ©lection du lieu -->
    <div class="form-group">
      <label for="location">ğŸ“ Lieu :</label>
      <select id="location" class="menu-select">
        {% for loc in locations_coords.keys() %}
          <option value="{{ loc }}" {% if selected_location == loc %}selected{% endif %}>{{ loc|capitalize }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Choix des sections -->
    <div class="form-group">
      <label>ğŸ“Œ Afficher :</label>
      <div>
        <label><input type="checkbox" id="toggle-weather"> MÃ©tÃ©o du jour</label><br>
        <label><input type="checkbox" id="toggle-wind"> PrÃ©visions Vent</label><br>
        <label><input type="checkbox" id="toggle-surf"> PrÃ©visions Surf</label><br>
        <label><input type="checkbox" id="toggle-webcams"> Webcams</label>
        <label><input type="checkbox" id="toggle-general-weather"> MÃ©tÃ©o gÃ©nÃ©rale</label>
        <label><input type="checkbox" id="toggle-openmeteo-weather"> PrÃ©visions Open-Meteo</label>

      </div>
    </div>
  </form>
</section>


<!-- Station locale -->
<section class="card" id="section-station">
  <h2>ğŸ›°ï¸ Station locale</h2>

  <div class="station-live">
    <div class="station-item">
      <div class="station-label">TempÃ©rature</div>
      <div class="station-value">
        {% if temperature is not none %}
          {{ temperature|round(1) }}<span class="unit">Â°C</span>
        {% else %} â€” {% endif %}
      </div>
    </div>

    <div class="station-item">
      <div class="station-label">HumiditÃ©</div>
      <div class="station-value">
        {% if humidity is not none %}
          {{ humidity|round(1) }}<span class="unit">%</span>
        {% else %} â€” {% endif %}
      </div>
    </div>

    <div class="station-timestamp">
      â± DerniÃ¨re mesureÂ : {{ timestamp or 'â€”' }}
    </div>
  </div>
</section>




<!-- MÃ©tÃ©o actuelle -->
<section class="card weather-today section-toggle" id="section-weather">
  <h2>ğŸŒ¤ï¸ MÃ©tÃ©o du jour</h2>
  <div class="weather-info">
    <div class="weather-icon">
      {% if current_precipitation == 0 and current_cloud_cover < 20 %}â˜€ï¸
      {% elif current_precipitation == 0 and current_cloud_cover < 50 %}ğŸŒ¤ï¸
      {% elif current_precipitation >= 0 %}ğŸŒ§ï¸
      {% else %}â˜ï¸{% endif %}
    </div>
    <div>
      <p>ğŸŒ¡ TempÃ©rature : <strong>{{ current_temperature|round(1) if current_temperature else "N/A" }} Â°C</strong></p>
      <p>ğŸ’¨ Vent : <strong>{{ (current_wind_speed * 1.94384)|round(1) if current_wind_speed else "N/A" }} nds</strong>
        <span class="wind-arrow" style="transform: rotate({{ current_wind_direction|round(0) if current_wind_direction else 0 }}deg);">â†‘</span>
      </p>
    </div>
  </div>
</section>

<!-- Bulletin mÃ©tÃ©o -->
<section class="card section-toggle" id="section-weather-extra">
  <h2>ğŸ•˜ {{ bulletin_date_label }}</h2>
  <div class="bulletin-grid">
    {% for item in daily_bulletin %}
      <div class="bulletin-item">
        <div class="bulletin-icon">{{ item.icon }}</div>
        <div><strong>{{ item.hour }}</strong></div>
        <div>{{ item.temp }}</div>
      </div>
    {% endfor %}
  </div>
</section>

<!-- PrÃ©visions Vent -->
<section class="card wind-forecast section-toggle" id="section-wind">
  <h2>ğŸ’¨ PrÃ©visions Vent</h2>
  <div class="wind-grid">
    {% for date, entries in grouped_avg.items() %}
      <h3 class="wind-day">{{ date }}</h3>
      <div class="wind-cards">
        {% for entry in entries %}
          {% set ws_kt = (entry.speed * 1.94384)|round(1) %}
          {% if ws_kt < 8 %}
            {% set color_class = "wind-low" %}
          {% elif ws_kt < 15 %}
            {% set color_class = "wind-medium" %}
          {% else %}
            {% set color_class = "wind-high" %}
          {% endif %}
          <div class="wind-card {{ color_class }}">
            <div class="wind-time">{{ entry.time }}</div>
            <div class="wind-speed">{{ ws_kt }} nds</div>
            <div class="wind-dir" style="transform: rotate({{ entry.direction|round(0) }}deg);">â†‘</div>
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>
</section>



<!-- MÃ©tÃ©o gÃ©nÃ©rale -->
<section class="card section-toggle" id="section-general-weather">
  <h2>ğŸ“‹ MÃ©tÃ©o gÃ©nÃ©rale (Meteostat)</h2>
  {% if meteostat_forecast %}
    {% set grouped_days = {} %}
    {% for i in range(meteostat_forecast.forecast_time|length) %}
      {% set date_str = meteostat_forecast.forecast_time[i][:10] %}
      {% if date_str not in grouped_days %}
        {% set _ = grouped_days.update({date_str: []}) %}
      {% endif %}
      {% set _ = grouped_days[date_str].append(i) %}
    {% endfor %}

    {% for day, indexes in grouped_days.items() %}
      <h3 class="general-weather-day">{{ day }}</h3>
      <div class="general-weather-table-wrapper">
        <table class="general-weather-table">
          <thead>
            <tr>
              <th>Heure</th>
              <th>ğŸŒ¡ Temp (Â°C)</th>
              <th>ğŸ’§ Hum (%)</th>
              <th>ğŸ”½ Press (hPa)</th>
              <th>ğŸŒ§ PrÃ©cip (mm)</th>
              <th>â˜ï¸ Nuages (%)</th>
            </tr>
          </thead>
          <tbody>
            {% for idx in indexes %}
              <tr>
                <td>{{ meteostat_forecast.forecast_time[idx][11:16] }}</td>
                <td>{{ meteostat_forecast.temperature[idx]|default('N/A') }}</td>
                <td>{{ meteostat_forecast.humidity[idx]|default('N/A') }}</td>
                <td>{{ meteostat_forecast.pressure[idx]|default('N/A') }}</td>
                <td>{{ meteostat_forecast.precipitation[idx]|default('0') }}</td>
                <td>{{ meteostat_forecast.cloud_cover[idx]|default('N/A') }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% else %}
    <p>Aucune donnÃ©e Meteostat disponible pour cette localisation.</p>
  {% endif %}
</section>

<section class="card section-toggle" id="section-openmeteo-weather">
  <h2>ğŸ“‹ PrÃ©visions dÃ©taillÃ©es (Open-Meteo)</h2>
  {% if openmeteo_forecast %}
    {% set grouped_days = {} %}
    {% for i in range(openmeteo_forecast.forecast_time|length) %}
      {% set date_str = openmeteo_forecast.forecast_time[i][:10] %}
      {% if date_str not in grouped_days %}
        {% set _ = grouped_days.update({date_str: []}) %}
      {% endif %}
      {% set _ = grouped_days[date_str].append(i) %}
    {% endfor %}

    {% for day, indexes in grouped_days.items() %}
      <div class="weather-day-block">
        <div class="weather-day-header">{{ day }}</div>
        <div class="weather-table-wrapper">
          <table class="weather-table">
            <thead>
              <tr>
                <th>Heure</th>
                <th>ğŸŒ¡</th>
                <th>ğŸ’§</th>
                <th>ğŸ’¨</th>
                <th>ğŸŒ§</th>
                <th>â˜ï¸</th>
              </tr>
            </thead>
            <tbody>
              {% for idx in indexes %}
                <tr class="
                  {% if openmeteo_forecast.precipitation[idx] > 0 %} rain-row {% endif %}
                  {% if openmeteo_forecast.wind_speed[idx] > 10 %} strong-wind {% endif %}
                  {% if openmeteo_forecast.cloud_cover[idx] > 80 %} cloudy {% endif %}
                ">
                  <td>{{ openmeteo_forecast.forecast_time[idx][11:16] }}</td>
                  <td>{{ openmeteo_forecast.temperature[idx]|round(1) }}Â°C</td>
                  <td>{{ openmeteo_forecast.humidity[idx]|default('N/A') }}%</td>
                  <td>{{ openmeteo_forecast.wind_speed[idx]|round(1) }}</td>
                  <td>{{ openmeteo_forecast.precipitation[idx]|default(0) }}</td>
                  <td>{{ openmeteo_forecast.cloud_cover[idx]|default('N/A') }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>Aucune donnÃ©e Open-Meteo disponible pour cette localisation.</p>
  {% endif %}
</section>








<!-- Carte -->
<section class="card">
  <h2>ğŸ—ºï¸ Carte des Spots</h2>
  <div id="map" style="height: 500px; width: 100%; border-radius: 12px;"></div>
</section>

<!-- PrÃ©visions Houle -->
<section class="card surf-forecast section-toggle" id="section-surf">
  <h2>ğŸŒŠ PrÃ©visions de Houle</h2>
  {% for date, data in grouped_surf_forecast.items() %}
    <div class="day-block">
      <h3 class="day-title">{{ data.label|capitalize }}</h3>
      <div class="forecast-grid">
        {% for entry in data.entries %}
          <div class="forecast-card quality-{{ entry.surf_score.emoji }}">
            <div class="forecast-time">{{ entry.time }}</div>
            <div class="forecast-info">
              <div class="wave">
                ğŸŒŠ {{ entry.height|round(1) }} m
                <small>â± {{ entry.period|round(0) }} s</small>
              </div>
              <div class="wind">
                ğŸ’¨ {{ (entry.wind_speed * 1.94384)|round(1) }} nds
                <span class="wind-arrow" style="transform: rotate({{ entry.wind_dir|round(0) }}deg);">â†‘</span>
              </div>
            </div>
            <div class="surf-score">{{ entry.surf_score.emoji }}</div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</section>

<!-- Modal pour plein Ã©cran -->
<div id="webcam-modal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <iframe id="modal-iframe" src="" style="width:100%; height:100%; border:none;"></iframe>
  </div>
</div>

<!-- Webcams -->
<section class="card webcam-section section-toggle" id="section-webcams">
  <h2>ğŸ“¹ Webcams en direct</h2>
  <div class="webcam-grid">
    {% for cam in webcams %}
    <div class="webcam-card" data-iframe="{{ cam.iframe }}">
      <iframe src="{{ cam.iframe }}"
        style="width:100%; height:250px; border:none; border-radius:8px;"
        allowfullscreen>
      </iframe>
      <div class="webcam-info">
        <h3>{{ cam.name }}</h3>
        <a href="{{ cam.iframe }}" target="_blank" class="webcam-btn">ğŸ¥ Voir en direct</a>
        <button class="webcam-fullscreen">â›¶ Plein Ã©cran</button>
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<!-- Refresh -->
<section class="card">
  <p class="refresh-note">
    Actualisation automatique toutes les 60s |
    <button id="refreshBtn" class="btn-secondary">ğŸ”„ Actualiser</button>
  </p>
</section>

{% endblock %}
